// This will become a separate module someday!

"use strict";

const glob = require("glob");
const path = require("path");
const sass = require("node-sass");

// Hack to keep track of 'sessions'
let usedMap = new Map();

let normalize = (url) => {
	url = path.normalize(url);

	let parsed = path.parse(url);

	url = url.slice(0, url.length - parsed.ext.length);

	return url;
}

module.exports = function(url, prev, done) {
	if (!usedMap.has(this.options.importer)) {
		usedMap.set(this.options.importer, new Set());
	}

	let usedSet = usedMap.get(this.options.importer);

	let cwd = this.options.includePaths;
	if (path.isAbsolute(prev)) {
		cwd = path.dirname(prev);
	}

	if (!glob.hasMagic(url)) {
		let fullPath = url;
		if (!path.isAbsolute(url)) {
			fullPath = path.join(cwd, url);
		}

		fullPath = normalize(fullPath);

		if (usedSet.has(fullPath)) {
			return {
				contents: "\n"
			};
		}

		usedSet.add(fullPath);

		return {
			file: url
		};
	}

	glob(url, {cwd: cwd}, (err, files) => {
		if (err) {
			return console.error(err);
		}

		let imports = [];

		for (let file of files) {
			if (!/\.s[ac]ss$/.test(file)) {
				// This isn't a Sass file!
				continue;
			}

			let fullPath = file;
			if (!path.isAbsolute(file)) {
				fullPath = path.join(cwd, file);
			}

			fullPath = normalize(fullPath);

			let escaped = fullPath.replace(/\\/g, "\\\\");

			imports.push(`@import "${escaped}";${this.options.linefeed}`);
		}

		done({
			contents: imports.join("\n")
		});
	});
}